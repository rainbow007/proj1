"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_=require("./"),_2=_interopRequireDefault(_),_toHost=require("./to-host"),_toHost2=_interopRequireDefault(_toHost),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_isZeitWorld=require("./is-zeit-world"),_isZeitWorld2=_interopRequireDefault(_isZeitWorld),_domainRegex2=require("domain-regex"),_domainRegex3=_interopRequireDefault(_domainRegex2),_errors=require("./errors"),_dns=require("./dns"),domainRegex=(0,_domainRegex3.default)(),Alias=function(e){function r(){return(0,_classCallCheck3.default)(this,r),(0,_possibleConstructorReturn3.default)(this,(0,_getPrototypeOf2.default)(r).apply(this,arguments))}return(0,_inherits3.default)(r,e),(0,_createClass3.default)(r,[{key:"ls",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,n;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!r){e.next=11;break}return e.next=3,this.findDeployment(r);case 3:if(t=e.sent){e.next=8;break}throw n=new Error('Aliases not found by "'+r+'". Run '+_chalk2.default.dim("`now alias ls`")+" to see your aliases."),n.userError=!0,n;case 8:return e.abrupt("return",this.listAliases(t.uid));case 11:return e.abrupt("return",this.listAliases());case 12:case"end":return e.stop()}},e,this)}));return e}()},{key:"rm",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.retry(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(n,a){var o,s;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t._fetch("/now/aliases/"+r.uid,{method:"DELETE"});case 2:if(o=e.sent,403!==o.status){e.next=5;break}return e.abrupt("return",n(new Error("Unauthorized")));case 5:if(200===o.status){e.next=8;break}throw s=new Error("Deletion failed. Try again later.");case 8:case"end":return e.stop()}},e,t)}));return function(r,t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}},e,this)}));return e}()},{key:"findDeployment",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,n,a,o,s=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.list();case 2:return t=e.sent,n=void 0,a=void 0,/\./.test(r)?(a=(0,_toHost2.default)(r),n="url"):(a=r,n="uid"),o=t.find(function(e){return e[n]===a?(s._debug&&console.log("> [debug] matched deployment "+e.uid+" by "+n+" "+a),!0):a+".now.sh"===e.url&&(s._debug&&console.log("> [debug] matched deployment "+e.uid+" by url "+e.url),!0)}),e.abrupt("return",o);case 7:case"end":return e.stop()}},e,this)}));return e}()},{key:"set",value:function(){function e(e,t){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,o,s,u,i,l,c,d,f,h,p,_,b=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=t.toLowerCase(),t=t.replace(/^\.+/,"").replace(/\.+$/,""),e.next=4,this.findDeployment(r);case 4:if(n=e.sent){e.next=9;break}throw a=new Error('Deployment not found by "'+r+'". Run '+_chalk2.default.dim("`now ls`")+" to see your deployments."),a.userError=!0,a;case 9:if(/\./.test(t)?t=(0,_toHost2.default)(t):(this._debug&&console.log("> [debug] suffixing `.now.sh` to alias "+t),t+=".now.sh"),domainRegex.test(t)){e.next=14;break}throw o=new Error('Invalid alias "'+t+'"'),o.userError=!0,o;case 14:if(/\.now\.sh$/.test(t)){e.next=70;break}return console.log("> "+_chalk2.default.bold(_chalk2.default.underline(t))+" is a custom domain."),console.log("> Verifying the DNS settings for "+_chalk2.default.bold(_chalk2.default.underline(t))+" (see "+_chalk2.default.underline("https://zeit.world")+" for help)"),e.prev=17,e.next=20,this.verifyOwnership(t);case 20:e.next=69;break;case 22:if(e.prev=22,e.t0=e.catch(17),!e.t0.userError){e.next=68;break}return e.prev=25,e.next=28,this.getNameservers(t);case 28:if(s=e.sent,u=s.domain,i=s.nameservers,this._debug&&console.log("> [debug] Found domain "+u+" and nameservers "+i),!(0,_isZeitWorld2.default)(i)){e.next=56;break}if(console.log("> Detected "+_chalk2.default.bold(_chalk2.default.underline("zeit.world"))+" nameservers! Configuring records."),l=t.substr(0,t.length-u.length),c=l.replace(/^\./,"").replace(/\.$/,""),d=u.replace(/^\./,"").replace(/\.$/,""),""!==c){e.next=40;break}return e.next=40,this.setupRecord(d,"*");case 40:return e.next=42,this.setupRecord(d,c);case 42:return this.recordSetup=!0,console.log("> DNS Configured! Verifying propagationâ€¦"),e.prev=44,e.next=47,this.retry(function(){return b.verifyOwnership(t)},{retries:10,maxTimeout:8e3});case 47:e.next=54;break;case 49:throw e.prev=49,e.t1=e.catch(44),f=new Error("> We configured the DNS settings for your alias, but we were unable to verify that they've propagated. Please try the alias again later."),f.userError=!0,f;case 54:e.next=59;break;case 56:throw console.log("> Resolved IP: "+(e.t0.ip?_chalk2.default.underline(e.t0.ip)+" (unknown)":_chalk2.default.dim("none"))),console.log("> Nameservers: "+(i&&i.length?i.map(function(e){return _chalk2.default.underline(e)}).join(", "):_chalk2.default.dim("none"))),e.t0;case 59:e.next=66;break;case 61:if(e.prev=61,e.t2=e.catch(25),!e.t2.userError){e.next=65;break}throw e.t2;case 65:throw e.t0;case 66:e.next=69;break;case 68:throw e.t0;case 69:console.log("> Verification "+_chalk2.default.bold("OK")+"!");case 70:return e.next=72,this.createAlias(n,t);case 72:h=e.sent,p=h.created,_=h.uid,p?console.log(_chalk2.default.cyan("> Success!")+" Alias created "+_chalk2.default.dim("("+_+")")+": "+_chalk2.default.bold(_chalk2.default.underline("https://"+t))+" now points to "+_chalk2.default.bold("https://"+n.url)+" "+_chalk2.default.dim("("+n.uid+")")):console.log(_chalk2.default.cyan("> Success!")+" Alias already exists "+_chalk2.default.dim("("+_+")")+".");case 76:case"end":return e.stop()}},e,this,[[17,22],[25,61],[44,49]])}));return e}()},{key:"createAlias",value:function(e,r){var t=this;return this.retry(function(){var n=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function n(a,o){var s,u,i,l,c,d,f;return _regenerator2.default.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return t._debug&&console.time("> [debug] /now/deployments/"+e.uid+"/aliases #"+o),n.next=3,t._fetch("/now/deployments/"+e.uid+"/aliases",{method:"POST",body:{alias:r}});case 3:return s=n.sent,n.next=6,s.json();case 6:if(u=n.sent,t._debug&&console.timeEnd("> [debug] /now/deployments/"+e.uid+"/aliases #"+o),409!==s.status){n.next=10;break}return n.abrupt("return",{uid:u.error.uid});case 10:if(403!==s.status){n.next=25;break}if(i=u.error.code,"custom_domain_needs_upgrade"!==i){n.next=16;break}return l=new Error("Custom domains are only enabled for premium accounts. Please upgrade at "+_chalk2.default.underline("https://zeit.co/account")+"."),l.userError=!0,n.abrupt("return",a(l));case 16:if("alias_in_use"!==i){n.next=20;break}return c=new Error("The alias you are trying to configure ("+_chalk2.default.underline(_chalk2.default.bold(r))+") is already in use by a different account."),c.userError=!0,n.abrupt("return",a(c));case 20:if("forbidden"!==i){n.next=24;break}return d=new Error("The domain you are trying to use as an alias is already in use by a different account."),d.userError=!0,n.abrupt("return",a(d));case 24:return n.abrupt("return",a(new Error("Authorization error")));case 25:if(!u.error){n.next=41;break}if(f=u.error.code,"deployment_not_found"!==f){n.next=29;break}return n.abrupt("return",a(new Error("Deployment not found")));case 29:if("cert_missing"!==f){n.next=40;break}return console.log("> Provisioning certificate for "+_chalk2.default.underline(_chalk2.default.bold(r))),n.prev=31,n.next=34,t.createCert(r);case 34:n.next=39;break;case 36:return n.prev=36,n.t0=n.catch(31),n.abrupt("return",a(n.t0));case 39:return n.abrupt("return",t.createAlias(e,r));case 40:return n.abrupt("return",a(new Error(u.error.message)));case 41:if(200===s.status||304===s.status){n.next=43;break}throw new Error("Unhandled error");case 43:return n.abrupt("return",u);case 44:case"end":return n.stop()}},n,t,[[31,36]])}));return function(e,r){return n.apply(this,arguments)}}())}},{key:"setupRecord",value:function(){function e(e,t){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.setupDomain(r);case 2:return this._debug&&console.log('> [debug] Setting up record "'+t+'" for "'+r+'"'),n=""===t?"ALIAS":"CNAME",e.abrupt("return",this.retry(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(o,s){var u,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a._debug&&console.time("> [debug] /domains/"+r+"/records #"+s),e.next=3,a._fetch("/domains/"+r+"/records",{method:"POST",body:{type:n,name:""===t?t:"*",value:"alias.zeit.co"}});case 3:if(u=e.sent,a._debug&&console.timeEnd("> [debug] /domains/"+r+"/records #"+s),403!==u.status){e.next=7;break}return e.abrupt("return",o(new Error("Unauthorized")));case 7:return e.next=9,u.json();case 9:if(i=e.sent,200===u.status){e.next=12;break}throw new Error(i.error.message);case 12:return e.abrupt("return",i);case 13:case"end":return e.stop()}},e,a)}));return function(r,t){return e.apply(this,arguments)}}()));case 5:case"end":return e.stop()}},e,this)}));return e}()},{key:"verifyOwnership",value:function(e){var r=this;return this.retry(function(){var t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function t(n,a){var o,s,u,i,l,c,d,f,h,p;return _regenerator2.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,_dns.resolve4)("alias.zeit.co");case 2:if(o=t.sent,o.length){t.next=5;break}return t.abrupt("return",n(new Error("Unable to resolve alias.zeit.co")));case 5:return s=[],t.prev=6,t.next=9,(0,_dns.resolve4)(e);case 9:s=t.sent,t.next=19;break;case 12:if(t.prev=12,t.t0=t.catch(6),"ENODATA"!==t.t0.code&&"ESERVFAIL"!==t.t0.code&&"ENOTFOUND"!==t.t0.code){t.next=18;break}r._debug&&console.log('> [debug] No records found for "'+e+'"'),t.next=19;break;case 18:throw t.t0;case 19:if(s.length){t.next=23;break}return u=new Error(_errors.DOMAIN_VERIFICATION_ERROR),u.userError=!0,t.abrupt("return",n(u));case 23:i=!0,l=!1,c=void 0,t.prev=26,d=(0,_getIterator3.default)(s);case 28:if(i=(f=d.next()).done){t.next=38;break}if(h=f.value,~o.indexOf(h)){t.next=35;break}return p=new Error("The domain "+e+" has an A record "+_chalk2.default.bold(h)+" that doesn't resolve to "+_chalk2.default.bold(_chalk2.default.underline("alias.zeit.co"))+".\n> "+_errors.DOMAIN_VERIFICATION_ERROR),p.ip=h,p.userError=!0,t.abrupt("return",n(p));case 35:i=!0,t.next=28;break;case 38:t.next=44;break;case 40:t.prev=40,t.t1=t.catch(26),l=!0,c=t.t1;case 44:t.prev=44,t.prev=45,!i&&d.return&&d.return();case 47:if(t.prev=47,!l){t.next=50;break}throw c;case 50:return t.finish(47);case 51:return t.finish(44);case 52:case"end":return t.stop()}},t,r,[[6,12],[26,40,44,52],[45,,47,51]])}));return function(e,r){return t.apply(this,arguments)}}())}},{key:"createCert",value:function(e){var r=this;return this.retry(function(){var t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function t(n,a){var o,s,u,i,l;return _regenerator2.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r._debug&&console.time("> [debug] /now/certs #"+a),t.next=3,r._fetch("/now/certs",{method:"POST",body:{domains:[e]}});case 3:if(o=t.sent,304!==o.status){t.next=7;break}return console.log("> Certificate already issued."),t.abrupt("return");case 7:return t.next=9,o.json();case 9:if(s=t.sent,r._debug&&console.timeEnd("> [debug] /now/certs #"+a),!s.error){t.next=24;break}if(u=s.error.code,"verification_failed"!==u){t.next=19;break}throw i=new Error("The certificate issuer failed to verify ownership of the domain. This likely has to do with DNS propagation and caching issues. Please retry later!"),i.userError=!0,i;case 19:if("rate_limited"!==u){t.next=23;break}return l=new Error(s.error.message),l.userError=!0,t.abrupt("return",n(l));case 23:throw new Error(s.message);case 24:if(200===o.status||304===o.status){t.next=26;break}throw new Error("Unhandled error");case 26:case"end":return t.stop()}},t,r)}));return function(e,r){return t.apply(this,arguments)}}(),{retries:5,minTimeout:3e4,maxTimeout:9e4})}}]),r}(_2.default);exports.default=Alias;