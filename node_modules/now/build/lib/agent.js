"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_spdy=require("spdy"),_spdy2=_interopRequireDefault(_spdy),_nodeFetch=require("node-fetch"),_nodeFetch2=_interopRequireDefault(_nodeFetch),_url=require("url"),Agent=function(){function e(t){var r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=r.tls,i=void 0===n||n,o=r.debug;(0,_classCallCheck3.default)(this,e),this._url=t;var s=(0,_url.parse)(t);this._host=s.hostname,this._port=s.port,this._protocol=s.protocol,this._debug=o,i&&this._initAgent()}return(0,_createClass3.default)(e,[{key:"_initAgent",value:function(){var e=this;"https:"===this._protocol&&(this._agent=_spdy2.default.createAgent({host:this._host,port:this._port||443}).once("error",function(t){return e._onError(t)}))}},{key:"_onError",value:function(e){this._debug&&console.log("> [debug] agent connection error",e.stack),this._error=e}},{key:"fetch",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];this._error&&(this._debug&&console.log("> [debug] re-initializing agent after error"),this._error=null,this._initAgent());var r=t.body;return this._agent&&(t.agent=this._agent),r&&"object"===("undefined"==typeof r?"undefined":(0,_typeof3.default)(r))&&"function"!=typeof r.pipe&&(t.headers["Content-Type"]="application/json",t.body=(0,_stringify2.default)(r)),null!=t.body&&"function"!=typeof r.pipe&&(t.headers["Content-Length"]=Buffer.byteLength(t.body)),(0,_nodeFetch2.default)(this._url+e,t)}},{key:"close",value:function(){this._debug&&console.log("> [debug] closing agent"),this._agent&&this._agent.close()}}]),e}();exports.default=Agent;