"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t]);return r.default=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function sleep(e){return new _promise2.default(function(r,t){setTimeout(r,e)})}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),getVerificationToken=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,o,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n="Now CLI "+_os2.default.platform()+"-"+_os2.default.arch()+" "+_package2.default.version+" ("+_os2.default.hostname()+")",a=(0,_stringify2.default)({email:t,tokenName:n}),e.next=4,(0,_nodeFetch2.default)(r+"/now/registration",{method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(a),"User-Agent":_ua2.default},body:a});case 4:if(o=e.sent,200===o.status){e.next=7;break}throw new Error("Verification error");case 7:return e.next=9,o.json();case 9:return i=e.sent,e.abrupt("return",i.token);case 11:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),verify=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t,n){var a,o,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a={email:t,token:n},e.next=3,(0,_nodeFetch2.default)(r+"/now/registration/verify?"+(0,_querystring.stringify)(a),{headers:{"User-Agent":_ua2.default}});case 3:return o=e.sent,e.next=6,o.json();case 6:return i=e.sent,e.abrupt("return",i.token);case 8:case"end":return e.stop()}},e,this)}));return function(r,t,n){return e.apply(this,arguments)}}(),register=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,n,a,o=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=o.retryEmail,u=void 0!==i&&i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_emailPrompt2.default)({invalid:u});case 2:if(t=e.sent,process.stdout.write("\n"),(0,_emailValidator.validate)(t)){e.next=6;break}return e.abrupt("return",register(r,{retryEmail:!0}));case 6:return e.next=8,getVerificationToken(r,t);case 8:n=e.sent,console.log("> Please follow the link sent to "+_chalk2.default.bold(t)+" to log in."),process.stdout.write("> Waiting for confirmation.."),a=void 0;case 12:return e.next=14,sleep(2500);case 14:return e.prev=14,e.next=17,verify(r,t,n);case 17:a=e.sent,e.next=22;break;case 20:e.prev=20,e.t0=e.catch(14);case 22:process.stdout.write(".");case 23:if(!a){e.next=12;break}case 24:return process.stdout.write("\n"),e.abrupt("return",{email:t,token:a});case 26:case"end":return e.stop()}},e,this,[[14,20]])}));return function(r,t){return e.apply(this,arguments)}}(),_os=require("os"),_os2=_interopRequireDefault(_os),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_nodeFetch=require("node-fetch"),_nodeFetch2=_interopRequireDefault(_nodeFetch),_cfg=require("./cfg"),cfg=_interopRequireWildcard(_cfg),_querystring=require("querystring"),_emailValidator=require("email-validator"),_emailPrompt=require("email-prompt"),_emailPrompt2=_interopRequireDefault(_emailPrompt),_ua=require("./ua"),_ua2=_interopRequireDefault(_ua),_package=require("../../package.json"),_package2=_interopRequireDefault(_package);exports.default=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,register(r);case 2:return t=e.sent,cfg.merge(t),e.abrupt("return",t.token);case 5:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}();