"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function toRelative(e,r){var t=r.endsWith(SEP)?r:r+SEP,n=e.substr(t.length);return n.startsWith(SEP)&&(n=n.substr(1)),n.replace(/\\/g,"/")}function responseError(e){var r=new Error("Response error");if(r.status=e.status,429===e.status){var t=e.headers.get("Retry-After");t&&(r.retryAfter=parseInt(t,10))}return r}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_from=require("babel-runtime/core-js/array/from"),_from2=_interopRequireDefault(_from),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_getFiles=require("./get-files"),_ua=require("./ua"),_ua2=_interopRequireDefault(_ua),_hash=require("./hash"),_hash2=_interopRequireDefault(_hash),_asyncRetry=require("async-retry"),_asyncRetry2=_interopRequireDefault(_asyncRetry),_agent=require("./agent"),_agent2=_interopRequireDefault(_agent),_events=require("events"),_events2=_interopRequireDefault(_events),_path=require("path"),_os=require("os"),_ini=require("ini"),_fsPromise=require("fs-promise"),_resumer=require("resumer"),_resumer2=_interopRequireDefault(_resumer),_splitArray=require("split-array"),_splitArray2=_interopRequireDefault(_splitArray),_dockerFileParser=require("docker-file-parser"),MAX_CONCURRENT=10,IS_WIN=/^win/.test(process.platform),SEP=IS_WIN?"\\":"/",Now=function(e){function r(e,t,n){var a=n.forceNew,s=void 0!==a&&a,o=n.debug,u=void 0!==o&&o;(0,_classCallCheck3.default)(this,r);var i=(0,_possibleConstructorReturn3.default)(this,(0,_getPrototypeOf2.default)(r).call(this));return i._token=t,i._debug=u,i._forceNew=s,i._agent=new _agent2.default(e,{debug:u}),i._onRetry=i._onRetry.bind(i),i}return(0,_inherits3.default)(r,e),(0,_createClass3.default)(r,[{key:"create",value:function(){function e(e,t){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,s,o,u,i,c,l,d,f,_,p,h,g=this,m=t.wantsPublic,b=t.quiet,y=void 0!==b&&b,v=t.forceNew,k=void 0!==v&&v,w=t.forceSync,x=void 0!==w&&w,E=t.forwardNpm,R=void 0!==E&&E,q=t.deploymentType,T=void 0===q?"npm":q;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._path=r,n={},a=void 0,s=void 0,o=void 0,"npm"!==T){e.next=29;break}return e.prev=4,e.next=7,(0,_fsPromise.readFile)((0,_path.resolve)(r,"package.json"));case 7:n=e.sent,n=JSON.parse(n),e.next=16;break;case 11:throw e.prev=11,e.t0=e.catch(4),u=Error('Failed to read JSON in "'+r+'/package.json"'),u.userError=!0,u;case 16:if(n.scripts&&(n.scripts.start||n.scripts["now-start"])){e.next=20;break}throw i=Error("Missing `start` (or `now-start`) script in `package.json`. See: https://docs.npmjs.com/cli/start."),i.userError=!0,i;case 20:return null==n.name||"string"!=typeof n.name?(a=(0,_path.basename)(r),y||console.log("> No `name` in `package.json`, using "+_chalk2.default.bold(a))):a=n.name,s=n.description,this._debug&&console.time("> [debug] Getting files"),e.next=25,(0,_getFiles.npm)(r,n,{debug:this._debug});case 25:o=e.sent,this._debug&&console.timeEnd("> [debug] Getting files"),e.next=31;break;case 29:if("docker"!==T){e.next=31;break}return e.delegateYield(_regenerator2.default.mark(function e(){var t,n,u,i,c,l,d;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=void 0,e.prev=1,e.next=4,(0,_fsPromise.readFile)((0,_path.resolve)(r,"Dockerfile"),"utf8");case 4:n=e.sent,t=(0,_dockerFileParser.parse)(n,{includeComments:!0}),e.next=13;break;case 8:throw e.prev=8,e.t0=e.catch(1),u=Error('Failed to parse "'+r+'/Dockerfile"'),u.userError=!0,u;case 13:if(t.length){e.next=17;break}throw i=Error("No commands found in `Dockerfile`"),i.userError=!0,i;case 17:if(t.some(function(e){return"CMD"===e.name})){e.next=21;break}throw c=Error("No `CMD` found in `Dockerfile`. See: https://docs.docker.com/engine/reference/builder/#/run"),c.userError=!0,c;case 21:if(t.some(function(e){return"EXPOSE"===e.name})){e.next=25;break}throw l=Error("No `EXPOSE` found in `Dockerfile`. A port must be supplied. See: https://docs.docker.com/engine/reference/builder/#/expose"),l.userError=!0,l;case 25:return d={},t.filter(function(e){return"LABEL"===e.name}).forEach(function(e){var r=e.args;for(var t in r)try{d[t]=JSON.parse(r[t])}catch(e){var n=Error("Error parsing value for LABEL "+t+" in `Dockerfile`");throw n.userError=!0,n}}),null==d.name?(a=(0,_path.basename)(r),y||console.log("> No `name` LABEL in `Dockerfile`, using "+_chalk2.default.bold(a))):a=d.name,s=d.description,g._debug&&console.time("> [debug] Getting files"),e.next=32,(0,_getFiles.docker)(r,{debug:g._debug});case 32:o=e.sent,g._debug&&console.timeEnd("> [debug] Getting files");case 34:case"end":return e.stop()}},e,g,[[1,8]])})(),"t1",31);case 31:if(c=n?n.now||{}:{},R=R||c.forwardNpm,l={},d=void 0,"npm"!==T||!R){e.next=57;break}return e.prev=36,e.next=39,(0,_fsPromise.readFile)((0,_path.resolve)(r,".npmrc"),"utf8");case 39:l=e.sent,l=(0,_ini.parse)(l),d=l["//registry.npmjs.org/:_authToken"],e.next=46;break;case 44:e.prev=44,e.t2=e.catch(36);case 46:if(d){e.next=57;break}return e.prev=47,e.next=50,(0,_fsPromise.readFile)((0,_path.resolve)((0,_os.homedir)(),".npmrc"),"utf8");case 50:l=e.sent,l=(0,_ini.parse)(l),d=l["//registry.npmjs.org/:_authToken"],e.next=57;break;case 55:e.prev=55,e.t3=e.catch(47);case 57:return this._debug&&console.time("> [debug] Computing hashes"),e.next=60,(0,_hash2.default)(o);case 60:return f=e.sent,this._debug&&console.timeEnd("> [debug] Computing hashes"),this._files=f,_=c.engines||n.engines,e.next=66,this.retry(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return g._debug&&console.time("> [debug] /now/create"),e.next=3,g._fetch("/now/create",{method:"POST",body:{public:m,forceNew:k,forceSync:x,name:a,description:s,deploymentType:T,registryAuthToken:d,files:Array.prototype.concat.apply([],(0,_from2.default)(g._files).map(function(e){var r=(0,_slicedToArray3.default)(e,2),t=r[0],n=r[1],a=n.data,s=n.names;return s.map(function(e){return{sha:t,size:a.length,file:toRelative(e,g._path)}})})),engines:_}});case 3:if(t=e.sent,g._debug&&console.timeEnd("> [debug] /now/create"),!(200!==t.status&&400<=t.status&&500>t.status)){e.next=8;break}return g._debug&&console.log("> [debug] bailing on creating due to %s",t.status),e.abrupt("return",r(responseError(t)));case 8:if(200===t.status){e.next=10;break}throw new Error("Deployment initialization failed");case 10:return e.abrupt("return",t.json());case 11:case"end":return e.stop()}},e,g)}));return function(r){return e.apply(this,arguments)}}());case 66:return p=e.sent,h=!1,p.warnings&&!function(){var e=0;p.warnings.forEach(function(r){if("size_limit_exceeded"===r.reason){var t=r.sha,n=r.limit,a=f.get(t).names.pop();console.error("> [31mWarning![39m Skipping file %s (size exceeded %s)",a,(0,_bytes2.default)(n)),f.get(t).names.unshift(a),e++}else if("node_version_not_found"===r.reason){var s=r.wanted,o=r.used;console.error("> [31mWarning![39m Requested node version %s is not available",s,o),h=!0}}),e&&console.error("> [31mWarning![39m "+e+" of the files exceeded the limit for your plan.\n"+("> See "+_chalk2.default.underline("https://zeit.co/account")+" to upgrade."))}(),!y&&p.nodeVersion&&(_&&_.node?h?console.log("> Using Node.js "+_chalk2.default.bold(p.nodeVersion)+" (default)"):console.log("> Using Node.js "+_chalk2.default.bold(p.nodeVersion)+" (requested: "+_chalk2.default.dim("`"+_.node+"`")+")"):console.log("> Using Node.js "+_chalk2.default.bold(p.nodeVersion)+" (default)")),this._id=p.deploymentId,this._host=p.url,this._missing=p.missing||[],e.abrupt("return",this._url);case 74:case"end":return e.stop()}},e,this,[[4,11],[36,44],[47,55]])}));return e}()},{key:"upload",value:function(){var e=this,r=(0,_splitArray2.default)(this._missing,MAX_CONCURRENT);this._debug&&console.log("> [debug] Will upload "+(this._missing.length+" files in "+r.length+" ")+("steps of "+MAX_CONCURRENT+" uploads."));var t=function t(){_promise2.default.all(r.shift().map(function(r){return(0,_asyncRetry2.default)(function(){var t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function t(n,a){var s,o,u,i,c;return _regenerator2.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return s=e._files.get(r),o=s.data,u=s.names,e._debug&&console.time("> [debug] /sync #"+a+" "+u.join(" ")),i=(0,_resumer2.default)().queue(o).end(),t.next=7,e._fetch("/now/sync",{method:"POST",headers:{"Content-Type":"application/octet-stream","Content-Length":o.length,"x-now-deployment-id":e._id,"x-now-sha":r,"x-now-file":u.map(function(r){return toRelative(r,e._path)}).join(","),"x-now-size":o.length},body:i});case 7:if(c=t.sent,e._debug&&console.timeEnd("> [debug] /sync #"+a+" "+u.join(" ")),200===c.status||!(400<=c.status||500>c.status)){t.next=12;break}return e._debug&&console.log("> [debug] bailing on creating due to %s",c.status),t.abrupt("return",n(responseError(c)));case 12:e.emit("upload",s);case 13:case"end":return t.stop()}},t,e)}));return function(e,r){return t.apply(this,arguments)}}(),{retries:3,randomize:!0,onRetry:e._onRetry})})).then(function(){return r.length?t():e.emit("complete")}).catch(function(r){return e.emit("error",r)})};t()}},{key:"list",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,n,a,s=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r?"?app="+encodeURIComponent(r):"",e.next=3,this.retry(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var n;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s._debug&&console.time("> [debug] /list"),e.next=3,s._fetch("/now/list"+t);case 3:if(n=e.sent,s._debug&&console.timeEnd("> [debug] /list"),!(400<=n.status&&500>n.status)){e.next=8;break}return s._debug&&console.log("> [debug] bailing on listing due to %s",n.status),e.abrupt("return",r(responseError(n)));case 8:if(200===n.status){e.next=10;break}throw new Error("Fetching deployment list failed");case 10:return e.abrupt("return",n.json());case 11:case"end":return e.stop()}},e,s)}));return function(r){return e.apply(this,arguments)}}(),{retries:3,minTimeout:2500,onRetry:this._onRetry});case 3:return n=e.sent,a=n.deployments,e.abrupt("return",a);case 6:case"end":return e.stop()}},e,this)}));return e}()},{key:"listAliases",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.retry(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(n,a){var s,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t._fetch(r?"/now/deployments/"+r+"/aliases":"/now/aliases");case 2:return s=e.sent,e.next=5,s.json();case 5:return o=e.sent,e.abrupt("return",o.aliases);case 7:case"end":return e.stop()}},e,t)}));return function(r,t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}},e,this)}));return e}()},{key:"getNameservers",value:function(e){var r=this,t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=t.fallback,a=void 0!==n&&n;try{return this.retry(function(){var t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function t(n,s){var o,u;return _regenerator2.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r._debug&&console.time("> [debug] #"+s+" GET /whois-ns"+(a?"-fallback":"")),t.next=3,r._fetch("/whois-ns"+(a?"-fallback":"")+"?domain="+encodeURIComponent(e));case 3:return o=t.sent,r._debug&&console.timeEnd("> [debug] #"+s+" GET /whois-ns"+(a?"-fallback":"")),t.next=7,o.json();case 7:if(u=t.sent,200!==o.status){t.next=14;break}if(u.nameservers&&0!==u.nameservers.length||a){t.next=11;break}return t.abrupt("return",r.getNameservers(e,{fallback:!0}));case 11:return t.abrupt("return",u);case 14:throw new Error("Whois error ("+o.status+"): "+u.error.message);case 15:case"end":return t.stop()}},t,r)}));return function(e,r){return t.apply(this,arguments)}}())}catch(r){if(a)throw r;return this.getNameservers(e,{fallback:!0})}}},{key:"setupDomain",value:function(e){var r=this;return this.retry(function(){var t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function t(n,a){var s,o,u,i,c;return _regenerator2.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r._debug&&console.time("> [debug] #"+a+" POST /domains"),t.next=3,r._fetch("/domains",{method:"POST",body:{name:e}});case 3:if(s=t.sent,r._debug&&console.timeEnd("> [debug] #"+a+" POST /domains"),403!==s.status){t.next=14;break}return t.next=8,s.json();case 8:return o=t.sent,u=o.error.code,i=void 0,i="custom_domain_needs_upgrade"===u?new Error("Custom domains are only enabled for premium accounts. Please upgrade at "+_chalk2.default.underline("https://zeit.co/account")+"."):new Error("Not authorized to access domain "+e),i.userError=!0,t.abrupt("return",n(i));case 14:return t.next=16,s.json();case 16:if(c=t.sent,409!==s.status){t.next=20;break}return r._debug&&console.log("> [debug] Domain already exists (noop)"),t.abrupt("return",{uid:c.error.uid});case 20:if(200===s.status){t.next=22;break}throw new Error(c.error.message);case 22:return t.abrupt("return",c);case 23:case"end":return t.stop()}},t,r)}));return function(e,r){return t.apply(this,arguments)}}())}},{key:"remove",value:function(){function e(e,t){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a=this,s=t.hard;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n={deploymentId:r,hard:s},e.next=3,this.retry(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a._debug&&console.time("> [debug] /remove"),e.next=3,a._fetch("/now/remove",{method:"DELETE",body:n});case 3:if(t=e.sent,a._debug&&console.timeEnd("> [debug] /remove"),!(400<=t.status&&500>t.status)){e.next=8;break}return a._debug&&console.log("> [debug] bailing on removal due to %s",t.status),e.abrupt("return",r(responseError(t)));case 8:if(200===t.status){e.next=10;break}throw new Error("Removing deployment failed");case 10:case"end":return e.stop()}},e,a)}));return function(r){return e.apply(this,arguments)}}());case 3:return e.abrupt("return",!0);case 4:case"end":return e.stop()}},e,this)}));return e}()},{key:"retry",value:function(e){var r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],t=r.retries,n=void 0===t?3:t,a=r.maxTimeout,s=void 0===a?1/0:a;return(0,_asyncRetry2.default)(e,{retries:n,maxTimeout:s,onRetry:this._onRetry})}},{key:"_onRetry",value:function(e){this._debug&&console.log("> [debug] Retrying: "+e.stack)}},{key:"close",value:function(){this._agent.close()}},{key:"_fetch",value:function(e){var r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return r.headers=r.headers||{},r.headers.authorization="Bearer "+this._token,r.headers["user-agent"]=_ua2.default,this._agent.fetch(e,r)}},{key:"id",get:function(){return this._id}},{key:"url",get:function(){return"https://"+this._host}},{key:"host",get:function(){return this._host}},{key:"syncAmount",get:function(){var e=this;return this._syncAmount||(this._syncAmount=this._missing.map(function(r){return e._files.get(r).data.length}).reduce(function(e,r){return e+r},0)),this._syncAmount}}]),r}(_events2.default);exports.default=Now;