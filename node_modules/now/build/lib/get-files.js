"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.docker=exports.npm=void 0;var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),npm=exports.npm=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,u,i,o,s,c,l,f=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],p=f.limit,d=void 0===p?null:p,_=f.debug,g=void 0!==_&&_;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.now&&t.now.files?t.now.files:t.files,a=n||["."],t.main&&a.push(t.main),u=a.map(function(e){return asAbsolute(e,r)}),e.next=6,maybeRead((0,_path.resolve)(r,".npmignore"),null);case 6:if(i=e.sent,e.t0=_gitignoreParser2.default,e.t1=_ignored2.default+"\n",null==i){e.next=13;break}e.t2=i,e.next=16;break;case 13:return e.next=15,maybeRead((0,_path.resolve)(r,".gitignore"));case 15:e.t2=e.sent;case 16:return e.t3=e.t2,e.t4=clearRelative(e.t3),e.t5=e.t1+e.t4,o=e.t0.compile.call(e.t0,e.t5),s=r.length+1,c=function(e){var r=o.accepts(e.substr(s));return!r&&g&&console.log('> [debug] ignoring "%s"',e),r},g&&console.time("> [debug] locating files"),e.next=25,explode(u,{accepts:c,limit:d,debug:g});case 25:return l=e.sent,g&&console.timeEnd("> [debug] locating files"),l.push(asAbsolute("package.json",r)),e.abrupt("return",(0,_arrayUnique2.default)(l));case 29:case"end":return e.stop()}},e,this)}));return function(r,t,n){return e.apply(this,arguments)}}(),docker=exports.docker=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,n,a,u,i,o,s=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],c=s.limit,l=void 0===c?null:c,f=s.debug,p=void 0!==f&&f;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=["."],n=t.map(function(e){return asAbsolute(e,r)}),e.t0=_gitignoreParser2.default,e.t1=_ignored2.default+"\n",e.next=6,maybeRead((0,_path.resolve)(r,".dockerignore"));case 6:return e.t2=e.sent,e.t3=e.t1+e.t2,a=e.t0.compile.call(e.t0,e.t3),u=r.length+1,i=function(e){var r=a.accepts(e.substr(u));return!r&&p&&console.log('> [debug] ignoring "%s"',e),r},p&&console.time("> [debug] locating files"),e.next=14,explode(n,{accepts:i,limit:l,debug:p});case 14:return o=e.sent,p&&console.timeEnd("> [debug] locating files"),o.push(asAbsolute("Dockerfile",r)),e.abrupt("return",(0,_arrayUnique2.default)(o));case 18:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),_arrFlatten=require("arr-flatten"),_arrFlatten2=_interopRequireDefault(_arrFlatten),_arrayUnique=require("array-unique"),_arrayUnique2=_interopRequireDefault(_arrayUnique),_minimatch=require("minimatch"),_minimatch2=_interopRequireDefault(_minimatch),_ignored=require("./ignored"),_ignored2=_interopRequireDefault(_ignored),_path=require("path"),_fsPromise=require("fs-promise"),_gitignoreParser=require("gitignore-parser"),_gitignoreParser2=_interopRequireDefault(_gitignoreParser),asAbsolute=function(e,r){return"/"===e[0]?e:(0,_path.resolve)(r,e)},explode=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,a,u=this,i=t.accepts;t.limit,t.debug;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_promise2.default.all(r.map(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a(r);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,u)}));return function(r){return e.apply(this,arguments)}}()));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,u)}));return function(r){return e.apply(this,arguments)}}(),a=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,a,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r,a=void 0,i(r)){e.next=4;break}return e.abrupt("return",null);case 4:return e.prev=4,e.next=7,(0,_fsPromise.stat)(t);case 7:a=e.sent,e.next=22;break;case 10:return e.prev=10,e.t0=e.catch(4),t=r+".js",e.prev=13,e.next=16,(0,_fsPromise.stat)(t);case 16:a=e.sent,e.next=22;break;case 19:return e.prev=19,e.t1=e.catch(13),e.abrupt("return",null);case 22:if(!a.isDirectory()){e.next=29;break}return e.next=25,(0,_fsPromise.readdir)(r);case 25:return o=e.sent,e.abrupt("return",n(o.map(function(e){return asAbsolute(e,r)})));case 29:return e.abrupt("return",t);case 30:case"end":return e.stop()}},e,u,[[4,10],[13,19]])}));return function(r){return e.apply(this,arguments)}}(),e.next=4,n(r);case 4:return e.t0=e.sent,e.t1=function(e){return null!==e},e.abrupt("return",(0,_arrFlatten2.default)(e.t0).filter(e.t1));case 7:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),maybeRead=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t=arguments.length<=1||void 0===arguments[1]?"":arguments[1];return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,_fsPromise.readFile)(r,"utf8");case 3:return e.abrupt("return",e.sent);case 6:return e.prev=6,e.t0=e.catch(0),e.abrupt("return",t);case 9:case"end":return e.stop()}},e,this,[[0,6]])}));return function(r,t){return e.apply(this,arguments)}}(),clearRelative=function(e){return e.replace(/(\n|^)\.\//g,"$1")};