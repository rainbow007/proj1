"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_lib=require("../lib"),_lib2=_interopRequireDefault(_lib),_isZeitWorld=require("./is-zeit-world"),_isZeitWorld2=_interopRequireDefault(_isZeitWorld),_domainRegex2=require("domain-regex"),_domainRegex3=_interopRequireDefault(_domainRegex2),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_errors=require("./errors"),domainRegex=(0,_domainRegex3.default)(),Domains=function(e){function r(){return(0,_classCallCheck3.default)(this,r),(0,_possibleConstructorReturn3.default)(this,(0,_getPrototypeOf2.default)(r).apply(this,arguments))}return(0,_inherits3.default)(r,e),(0,_createClass3.default)(r,[{key:"ls",value:function(){function e(){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.retry(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,n){var a,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r._debug&&console.time("> [debug] #"+n+" GET /domains"),e.next=3,r._fetch("/domains");case 3:return a=e.sent,r._debug&&console.timeEnd("> [debug] #"+n+" GET /domains"),e.next=7,a.json();case 7:return o=e.sent,e.abrupt("return",o.domains);case 9:case"end":return e.stop()}},e,r)}));return function(r,t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}},e,this)}));return e}()},{key:"rm",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.retry(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(n,a){var o,u;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t._debug&&console.time("> [debug] #"+a+" DELETE /domains/"+r),e.next=3,t._fetch("/domains/"+r,{method:"DELETE"});case 3:if(o=e.sent,t._debug&&console.timeEnd("> [debug] #"+a+" DELETE /domains/"+r),403!==o.status){e.next=7;break}return e.abrupt("return",n(new Error("Unauthorized")));case 7:if(200===o.status){e.next=12;break}return e.next=10,o.json();case 10:throw u=e.sent,new Error(u.error.message);case 12:case"end":return e.stop()}},e,t)}));return function(r,t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}},e,this)}));return e}()},{key:"add",value:function(){function e(e){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,n,a,o,u;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(domainRegex.test(r)){e.next=4;break}throw t=new Error("The supplied value "+_chalk2.default.bold('"'+r+'"')+" is not a valid domain."),t.userError=!0,t;case 4:return n=void 0,e.prev=5,console.log("> Verifying nameserversâ€¦"),e.next=9,this.getNameservers(r);case 9:a=e.sent,n=a.nameservers,e.next=18;break;case 13:throw e.prev=13,e.t0=e.catch(5),o=new Error("Unable to fetch nameservers for "+_chalk2.default.underline(_chalk2.default.bold(r))+"."),o.userError=!0,o;case 18:if(!(0,_isZeitWorld2.default)(n)){e.next=23;break}return console.log("> Verification "+_chalk2.default.bold("OK")+"!"),e.abrupt("return",this.setupDomain(r));case 23:throw this._debug&&console.log('> [debug] Supplied domain "'+r+'" has non-zeit nameservers'),u=new Error(_errors.DNS_VERIFICATION_ERROR),u.userError=!0,u;case 27:case"end":return e.stop()}},e,this,[[5,13]])}));return e}()}]),r}(_lib2.default);exports.default=Domains;