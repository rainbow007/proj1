#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(r[o]=e[o]);return r.default=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function printLogs(e){var r=new _buildLogger2.default(e,{debug:debug,quiet:quiet});r.on("close",function(){quiet||console.log(""+_chalk2.default.cyan("> Deployment complete!")),process.exit(0)})}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),sync=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var o,t,a,n,l,i,s,c,u,p,d,f=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=Date.now(),quiet||console.log("> Deploying "+_chalk2.default.bold((0,_toHumanPath2.default)(path))),e.prev=2,e.next=5,(0,_fsPromise.stat)(path);case 5:e.next=11;break;case 7:e.prev=7,e.t0=e.catch(2),(0,_error.error)("Could not read directory "+_chalk2.default.bold(path)),process.exit(1);case 11:if(t=void 0,a=void 0,n=void 0,!argv.docker){e.next=17;break}debug&&console.log("> [debug] Forcing `deploymentType` = `docker`"),t="docker",e.next=63;break;case 17:if(!argv.npm){e.next=21;break}t="npm",e.next=63;break;case 21:return e.prev=21,e.next=24,(0,_fsPromise.stat)((0,_path.resolve)(path,"package.json"));case 24:e.next=29;break;case 26:e.prev=26,e.t1=e.catch(21),a=!0;case 29:return e.t2=_promise2.default,e.next=32,(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,_fsPromise.stat)((0,_path.resolve)(path,"package.json"));case 3:e.next=8;break;case 5:return e.prev=5,e.t0=e.catch(0),e.abrupt("return",!1);case 8:return e.abrupt("return",!0);case 9:case"end":return e.stop()}},e,f,[[0,5]])}))();case 32:return e.t3=e.sent,e.next=35,(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,_fsPromise.stat)((0,_path.resolve)(path,"Dockerfile"));case 3:e.next=8;break;case 5:return e.prev=5,e.t0=e.catch(0),e.abrupt("return",!1);case 8:return e.abrupt("return",!0);case 9:case"end":return e.stop()}},e,f,[[0,5]])}))();case 35:return e.t4=e.sent,e.t5=[e.t3,e.t4],e.next=39,e.t2.all.call(e.t2,e.t5);case 39:if(l=e.sent,i=(0,_slicedToArray3.default)(l,2),a=i[0],n=i[1],!a||!n){e.next=62;break}if(debug&&console.log("[debug] multiple manifests found, disambiguating"),!isTTY){e.next=59;break}return e.prev=46,console.log("> Two manifests found. Press ["+_chalk2.default.bold("n")+"] to deploy or re-run with --flag"),e.next=50,(0,_promptOptions2.default)([["npm",_chalk2.default.bold("package.json")+"\t"+_chalk2.default.gray("   --npm")+" "],["docker",_chalk2.default.bold("Dockerfile")+"\t"+_chalk2.default.gray("--docker")+" "]]);case 50:t=e.sent,e.next=57;break;case 53:e.prev=53,e.t6=e.catch(46),(0,_error.error)(e.t6.message),process.exit(1);case 57:e.next=60;break;case 59:(0,_error.error)("Ambiguous deployment (`package.json` and `Dockerfile` found). Please supply `--npm` or `--docker` to disambiguate.");case 60:e.next=63;break;case 62:a?(debug&&console.log("[debug] `package.json` found, assuming `deploymentType` = `npm`"),t="npm"):n?(debug&&console.log("[debug] `Dockerfile` found, assuming `deploymentType` = `docker`"),t="docker"):((0,_error.error)("Could not read directory "+_chalk2.default.bold(path)),process.exit(1));case 63:return s=new _lib2.default(apiUrl,r,{debug:debug}),e.prev=64,e.next=67,s.create(path,{deploymentType:t,forceNew:forceNew,forceSync:forceSync,forwardNpm:alwaysForwardNpm||forwardNpm,quiet:quiet,wantsPublic:wantsPublic});case 67:e.next=74;break;case 69:e.prev=69,e.t7=e.catch(64),debug&&console.log("> [debug] error: "+e.t7.stack),(0,_error.handleError)(e.t7),process.exit(1);case 74:if(c=s.url,u=(0,_ms2.default)(new Date-o),!isTTY){e.next=92;break}if(!clipboard){e.next=89;break}return e.prev=78,e.next=81,(0,_copy2.default)(c);case 81:console.log(_chalk2.default.cyan("> Ready!")+" "+_chalk2.default.bold(c)+" (copied to clipboard) ["+u+"]"),e.next=87;break;case 84:e.prev=84,e.t8=e.catch(78),console.log(_chalk2.default.cyan("> Ready!")+" "+_chalk2.default.bold(c)+" ["+u+"]");case 87:e.next=90;break;case 89:console.log("> "+c+" ["+u+"]");case 90:e.next=93;break;case 92:process.stdout.write(c);case 93:p=new Date,d=function(){if(!quiet){var e=(0,_ms2.default)(new Date-p);console.log("> Sync complete ("+(0,_bytes2.default)(s.syncAmount)+") ["+e+"] "),console.log("> Initializing‚Ä¶")}s.close(),printLogs(s.host)},s.syncAmount?!function(){var e=new _progress2.default("> Upload [:bar] :percent :etas",{width:20,complete:"=",incomplete:"",total:s.syncAmount});s.upload(),s.on("upload",function(r){var o=r.names,t=r.data,a=t.length;debug&&console.log("> [debug] Uploaded: "+o.join(" ")+" ("+(0,_bytes2.default)(t.length)+")"),e.tick(a)}),s.on("complete",d),s.on("error",function(e){(0,_error.error)("Upload failed"),(0,_error.handleError)(e),process.exit(1)})}():(quiet||console.log("> Initializing‚Ä¶"),s.close(),printLogs(s.host));case 96:case"end":return e.stop()}},e,this,[[2,7],[21,26],[46,53],[64,69],[78,84]])}));return function(r){return e.apply(this,arguments)}}(),_progress=require("progress"),_progress2=_interopRequireDefault(_progress),_copy=require("../lib/copy"),_copy2=_interopRequireDefault(_copy),_path=require("path"),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_fsPromise=require("fs-promise"),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_package=require("../../package"),_buildLogger=require("../lib/build-logger"),_buildLogger2=_interopRequireDefault(_buildLogger),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_minimist=require("minimist"),_minimist2=_interopRequireDefault(_minimist),_lib=require("../lib"),_lib2=_interopRequireDefault(_lib),_toHumanPath=require("../lib/utils/to-human-path"),_toHumanPath2=_interopRequireDefault(_toHumanPath),_promptOptions=require("../lib/utils/prompt-options"),_promptOptions2=_interopRequireDefault(_promptOptions),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),_error=require("../lib/error"),argv=(0,_minimist2.default)(process.argv.slice(2),{boolean:["help","version","debug","force","login","no-clipboard","forward-npm","docker","npm"],alias:{help:"h",debug:"d",version:"v",force:"f",forceSync:"F",login:"L",public:"p","no-clipboard":"C","forward-npm":"N"}}),help=function(){console.log("\n  "+_chalk2.default.bold("ùö´ now")+" [options] <command | path>\n\n  "+_chalk2.default.dim("Commands:")+"\n\n    deploy       [path]       performs a deployment "+_chalk2.default.bold("(default)")+"\n    ls | list    [app]        list deployments\n    rm | remove  [id]         remove a deployment\n    ln | alias   [id] [url]   configures aliases for deployments\n    domains      [name]       manages your domain names\n    help         [cmd]        displays complete help for [cmd]\n\n  "+_chalk2.default.dim("Options:")+"\n\n    -h, --help          output usage information\n    -v, --version       output the version number\n    -d, --debug         debug mode [off]\n    -f, --force         force a new deployment even if nothing has changed\n    -L, --login         configure login\n    -p, --public        deployment is public (`/_src` is exposed) [on for oss, off for premium]\n    -C, --no-clipboard  do not attempt to copy URL to clipboard\n    -N, --forward-npm   Forward login information to install private NPM modules\n\n  "+_chalk2.default.dim("Examples:")+"\n\n  "+_chalk2.default.gray("‚Äì")+" Deploys the current directory\n\n    "+_chalk2.default.cyan("$ now")+"\n\n  "+_chalk2.default.gray("‚Äì")+" Deploys a custom path "+_chalk2.default.dim("`/usr/src/project`")+"\n\n    "+_chalk2.default.cyan("$ now /usr/src/project")+"\n\n  "+_chalk2.default.gray("‚Äì")+" Lists all deployments with their IDs\n\n    "+_chalk2.default.cyan("$ now ls")+"\n\n  "+_chalk2.default.gray("‚Äì")+" Associates deployment "+_chalk2.default.dim("`deploymentId`")+" with "+_chalk2.default.dim("`custom-domain.com`")+"\n\n    "+_chalk2.default.cyan("$ now alias deploymentId custom-domain.com")+"\n\n  "+_chalk2.default.gray("‚Äì")+" Displays comprehensive help for the subcommand "+_chalk2.default.dim("`list`")+"\n\n    "+_chalk2.default.cyan("$ now help list")+"\n")},path=argv._[0];path=null!=path?(0,_path.resolve)(process.cwd(),path):process.cwd();var exit=function(e){setTimeout(function(){return process.exit(e||0)},100)},debug=argv.debug,clipboard=!argv["no-clipboard"],forwardNpm=argv["forward-npm"],forceNew=argv.force,forceSync=argv.forceSync,shouldLogin=argv.login,wantsPublic=argv.public,apiUrl=argv.url||"https://api.zeit.co",isTTY=process.stdout.isTTY,quiet=!isTTY,config=cfg.read(),alwaysForwardNpm=config.forwardNpm;argv.h||argv.help?(help(),exit(0)):argv.v||argv.version?(console.log(_chalk2.default.bold("ùö´ now"),_package.version),process.exit(0)):!config.token||shouldLogin?(0,_login2.default)(apiUrl).then(function(e){shouldLogin?(console.log("> Logged in successfully. Token saved in ~/.now.json"),process.exit(0)):sync(e).catch(function(e){(0,_error.error)("Unknown error: "+e.stack),process.exit(1)})}).catch(function(e){(0,_error.error)("Authentication error ‚Äì "+e.message),process.exit(1)}):sync(config.token).catch(function(e){(0,_error.error)("Unknown error: "+e.stack),process.exit(1)});