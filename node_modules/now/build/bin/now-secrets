#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(r[a]=e[a]);return r.default=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function readConfirmation(e){return new _promise2.default(function(r,a){var t=_chalk2.default.gray((0,_ms2.default)(new Date-new Date(e.created))+" ago"),n=(0,_textTable2.default)([[e.uid,_chalk2.default.bold(e.name),t]],{align:["l","r","l"],hsep:" ".repeat(6)});process.stdout.write("> The following secret will be removed permanently\n"),process.stdout.write("  "+n+"\n"),process.stdout.write(_chalk2.default.bold.red("> Are you sure?")+" "+_chalk2.default.gray("[yN] ")),process.stdin.on("data",function(e){process.stdin.pause(),r("y"===e.toString().trim().toLowerCase())}).resume()})}var _slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_toArray2=require("babel-runtime/helpers/toArray"),_toArray3=_interopRequireDefault(_toArray2),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),run=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var a,t,n,u,l,o,s,c,i,d,f,_,m,p,b,h,g,y,k,v=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=new _secrets2.default(apiUrl,r,{debug:debug}),t=argv._.slice(1),n=Date.now(),"ls"!==subcommand&&"list"!==subcommand){e.next=8;break}return e.delegateYield(_regenerator2.default.mark(function e(){var r,u,l,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(0===t.length){e.next=3;break}return(0,_error.error)("Invalid number of arguments. Usage: "+_chalk2.default.cyan("`now secret ls`")),e.abrupt("return",{v:exit(1)});case 3:return e.next=5,a.ls();case 5:return r=e.sent,u=(0,_ms2.default)(new Date-n),console.log("> "+r.length+" secrets found "+_chalk2.default.gray("["+u+"]")),l=Date.now(),o=(0,_textTable2.default)(r.map(function(e){return["",e.uid,_chalk2.default.bold(e.name),_chalk2.default.gray((0,_ms2.default)(l-new Date(e.created))+" ago")]}),{align:["l","r","l"],hsep:" ".repeat(3)}),o&&console.log("\n"+o+"\n"),e.abrupt("return",{v:a.close()});case 12:case"end":return e.stop()}},e,v)})(),"t0",5);case 5:if(u=e.t0,"object"!==("undefined"==typeof u?"undefined":(0,_typeof3.default)(u))){e.next=8;break}return e.abrupt("return",u.v);case 8:if("rm"!==subcommand&&"remove"!==subcommand){e.next=34;break}if(1===t.length){e.next=12;break}return(0,_error.error)("Invalid number of arguments. Usage: "+_chalk2.default.cyan("`now secret rm <id | name>`")),e.abrupt("return",exit(1));case 12:return e.next=14,a.ls();case 14:if(l=e.sent,o=l.filter(function(e){return e.uid===t[0]||e.name===t[0]})[0],!o){e.next=26;break}return e.next=19,readConfirmation(o);case 19:if(s=e.sent){e.next=24;break}return console.log("woot"),(0,_error.error)("User abort"),e.abrupt("return",exit(0));case 24:e.next=28;break;case 26:return(0,_error.error)('No secret found by id or name "'+t[0]+'"'),e.abrupt("return",exit(1));case 28:return e.next=30,a.rm(t[0]);case 30:return c=e.sent,i=(0,_ms2.default)(new Date-n),console.log(_chalk2.default.cyan("> Success!")+" Secret "+_chalk2.default.bold(c.name)+" "+_chalk2.default.gray("("+c.uid+")")+" removed "+_chalk2.default.gray("["+i+"]")),e.abrupt("return",a.close());case 34:if("rename"!==subcommand){e.next=44;break}if(2===t.length){e.next=38;break}return(0,_error.error)("Invalid number of arguments. Usage: "+_chalk2.default.cyan("`now secret rename <old-name> <new-name>`")),e.abrupt("return",exit(1));case 38:return e.next=40,a.patch(t[0],t[1]);case 40:return d=e.sent,f=(0,_ms2.default)(new Date-n),console.log(_chalk2.default.cyan("> Success!")+" Secret "+_chalk2.default.bold(d.name)+" "+_chalk2.default.gray("("+d.uid+")")+" renamed to "+_chalk2.default.bold("my-secret-name")+" "+_chalk2.default.gray("["+f+"]")),e.abrupt("return",a.close());case 44:if("add"!==subcommand&&"set"!==subcommand){e.next=60;break}if(2===t.length){e.next=49;break}return(0,_error.error)("Invalid number of arguments. Usage: "+_chalk2.default.cyan("`now secret add <name> <value>`")),t.length>2&&(_=(0,_toArray3.default)(t),m=_.slice(1),console.log("> If your secret has spaces, make sure to wrap it in quotes. Example: \n"+("  "+_chalk2.default.cyan('$ now secret add ${args[0]} "${escaped}"')+" "))),e.abrupt("return",exit(1));case 49:return p=(0,_slicedToArray3.default)(t,2),b=p[0],h=p[1],g=void 0,g=argv.base64?{base64:h}:h,e.next=56,a.add(b,g);case 56:return y=e.sent,k=(0,_ms2.default)(new Date-n),console.log(_chalk2.default.cyan("> Success!")+" Secret "+_chalk2.default.bold(b)+" "+_chalk2.default.gray("("+y.uid+")")+" added "+_chalk2.default.gray("["+k+"]")),e.abrupt("return",a.close());case 60:(0,_error.error)("Please specify a valid subcommand: ls | add | rename | rm"),help(),exit(1);case 63:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}(),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_textTable=require("text-table"),_textTable2=_interopRequireDefault(_textTable),_minimist=require("minimist"),_minimist2=_interopRequireDefault(_minimist),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_error=require("../lib/error"),_secrets=require("../lib/secrets"),_secrets2=_interopRequireDefault(_secrets),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),argv=(0,_minimist2.default)(process.argv.slice(2),{boolean:["help","debug","base64"],alias:{help:"h",debug:"d",base64:"b"}}),subcommand=argv._[0],help=function(){console.log("\n  "+_chalk2.default.bold("ùö´ now secrets")+" <ls | add | rm> <domain>\n\n  "+_chalk2.default.dim("Options:")+"\n\n    -h, --help   output usage information\n    -b, --base64 treat value as base64-encoded\n    -d, --debug  debug mode [off]\n\n  "+_chalk2.default.dim("Examples:")+"\n\n  "+_chalk2.default.gray("‚Äì")+" Lists all your secrets:\n\n    "+_chalk2.default.cyan("$ now secrets ls")+"\n\n  "+_chalk2.default.gray("‚Äì")+" Adds a new secret:\n\n    "+_chalk2.default.cyan('$ now secrets add my-secret "my value"')+"\n\n    "+_chalk2.default.gray("‚Äì")+" Once added, a secret's value can't be retrieved in plaintext anymore\n    "+_chalk2.default.gray("‚Äì")+" If the secret's value is more than one word, wrap it in quotes\n    "+_chalk2.default.gray("‚Äì")+" Actually, when in doubt, wrap your value in quotes\n\n  "+_chalk2.default.gray("‚Äì")+" Exposes a secret as an env variable:\n\n    "+_chalk2.default.cyan("$ now -e MY_SECRET="+_chalk2.default.bold("@my-secret"))+"\n\n    Notice the "+_chalk2.default.cyan.bold("`@`")+" symbol which makes the value a secret reference.\n\n  "+_chalk2.default.gray("‚Äì")+" Renames a secret:\n\n    "+_chalk2.default.cyan("$ now secrets rename my-secret my-renamed-secret")+"\n\n  "+_chalk2.default.gray("‚Äì")+" Removes a secret:\n\n    "+_chalk2.default.cyan("$ now secrets rm my-secret")+"\n")},debug=argv.debug,apiUrl=argv.url||"https://api.zeit.co",exit=function(e){setTimeout(function(){return process.exit(e||0)},100)};if(argv.help||!subcommand)help(),exit(0);else{var config=cfg.read();_promise2.default.resolve(config.token||login(apiUrl)).then(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,run(r);case 3:e.next=9;break;case 5:e.prev=5,e.t0=e.catch(0),(0,_error.handleError)(e.t0),exit(1);case 9:case"end":return e.stop()}},e,void 0,[[0,5]])}));return function(r){return e.apply(this,arguments)}}()).catch(function(e){(0,_error.error)("Authentication error ‚Äì "+e.message),exit(1)})}process.on("uncaughtException",function(e){(0,_error.handleError)(e),exit(1)});