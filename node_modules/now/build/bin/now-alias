#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t]);return r.default=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function indent(e,r){return e.split("\n").map(function(e){return" ".repeat(r)+e}).join("\n")}function findAlias(e,r){var t=void 0,a=void 0;/\./.test(e)?(a=(0,_toHost2.default)(e),t="alias"):(a=e,t="uid");var n=r.find(function(e){return e[t]===a?(debug&&console.log("> [debug] matched alias "+e.uid+" by "+t+" "+a),!0):a+".now.sh"===e.alias&&(debug&&console.log("> [debug] matched alias "+e.uid+" by url "+e.host),!0)});return n}var _typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),run=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,a,n,i=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new _alias3.default(apiUrl,r,{debug:debug}),a=argv._.slice(1),e.delegateYield(_regenerator2.default.mark(function e(){var r,n,l,u,o,s,c,d,f,_,p,m,h;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=subcommand,e.next="list"===e.t0?3:"ls"===e.t0?3:"remove"===e.t0?18:"rm"===e.t0?18:"add"===e.t0?51:"set"===e.t0?51:57;break;case 3:if(0===a.length){e.next=6;break}return(0,_error.error)("Invalid number of arguments"),e.abrupt("return",{v:exit(1)});case 6:return e.next=8,t.list();case 8:return r=e.sent,n=new _map2.default(r.map(function(e){return[e.uid,e.url]})),e.next=12,t.ls();case 12:return l=e.sent,l.sort(function(e,r){return new Date(r.created)-new Date(e.created)}),u=new Date,o=(0,_textTable2.default)(l.map(function(e){var r=_chalk2.default.underline("https://"+e.alias),t=e.deploymentId,a=n.get(t)?_chalk2.default.underline("https://"+n.get(t)):_chalk2.default.gray("<null>"),i=_chalk2.default.gray((0,_ms2.default)(u-new Date(e.created))+" ago");return["",null==e.uid?"":e.uid,a,r,i]}),{align:["l","r","l"],hsep:" ".repeat(3)}),o&&console.log("\n"+o+"\n"),e.abrupt("break",63);case 18:if(s=String(a[0])){e.next=23;break}throw c=new Error("No alias id specified"),c.userError=!0,c;case 23:if(1===a.length){e.next=26;break}return(0,_error.error)("Invalid number of arguments"),e.abrupt("return",{v:exit(1)});case 26:return e.next=28,t.ls();case 28:if(d=e.sent,f=findAlias(s,d)){e.next=34;break}throw _=new Error('Alias not found by "'+s+'". Run '+_chalk2.default.dim("`now alias ls`")+" to see your aliases."),_.userError=!0,_;case 34:return e.prev=34,e.next=37,readConfirmation(t,f,d);case 37:return p=e.sent.toLowerCase(),"y"!==p&&"yes"!==p&&(console.log("\n> Aborted"),process.exit(0)),m=new Date,e.next=42,t.rm(f);case 42:h=(0,_ms2.default)(new Date-m),console.log(_chalk2.default.cyan("> Success!")+" Alias "+_chalk2.default.bold(f.uid)+" removed ["+h+"]"),e.next=50;break;case 46:e.prev=46,e.t1=e.catch(34),(0,_error.error)(e.t1),exit(1);case 50:return e.abrupt("break",63);case 51:if(2===a.length){e.next=54;break}return(0,_error.error)("Invalid number of arguments"),e.abrupt("return",{v:exit(1)});case 54:return e.next=56,t.set(String(a[0]),String(a[1]));case 56:return e.abrupt("break",63);case 57:if(2!==argv._.length){e.next=62;break}return e.next=60,t.set(String(argv._[0]),String(argv._[1]));case 60:e.next=63;break;case 62:argv._.length>=3?((0,_error.error)("Invalid number of arguments"),help(),exit(1)):((0,_error.error)("Please specify a valid subcommand: ls | set | rm"),help(),exit(1));case 63:case"end":return e.stop()}},e,i,[[34,46]])})(),"t0",3);case 3:if(n=e.t0,"object"!==("undefined"==typeof n?"undefined":(0,_typeof3.default)(n))){e.next=6;break}return e.abrupt("return",n.v);case 6:t.close();case 7:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}(),readConfirmation=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t,a){var n,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.list();case 2:return n=e.sent,i=new _map2.default(n.map(function(e){return[e.uid,e.url]})),e.abrupt("return",new _promise2.default(function(e,r){var a=_chalk2.default.gray((0,_ms2.default)(new Date-new Date(t.created))+" ago"),n=_chalk2.default.underline("https://"+i.get(t.deploymentId)),l=(0,_textTable2.default)([[t.uid,n,_chalk2.default.underline("https://"+t.alias),a]],{align:["l","r","l"],hsep:" ".repeat(6)});process.stdout.write("> The following alias will be removed permanently\n"),process.stdout.write("  "+l+"\n"),process.stdout.write("  "+_chalk2.default.bold.red("> Are you sure?")+" "+_chalk2.default.gray("[yN] ")),process.stdin.on("data",function(r){process.stdin.pause(),e(r.toString().trim())}).resume()}));case 5:case"end":return e.stop()}},e,this)}));return function(r,t,a){return e.apply(this,arguments)}}(),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_minimist=require("minimist"),_minimist2=_interopRequireDefault(_minimist),_textTable=require("text-table"),_textTable2=_interopRequireDefault(_textTable),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),_alias2=require("../lib/alias"),_alias3=_interopRequireDefault(_alias2),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_error=require("../lib/error"),_toHost=require("../lib/to-host"),_toHost2=_interopRequireDefault(_toHost),argv=(0,_minimist2.default)(process.argv.slice(2),{boolean:["help","debug"],alias:{help:"h",debug:"d"}}),subcommand=argv._[0],help=function(){console.log("\n  "+_chalk2.default.bold("ùö´ now alias")+" <ls | set | rm> <deployment> <alias>\n\n  "+_chalk2.default.dim("Options:")+"\n\n    -h, --help   output usage information\n    -d, --debug  debug mode [off]\n\n  "+_chalk2.default.dim("Examples:")+"\n\n  "+_chalk2.default.gray("‚Äì")+" Lists all your aliases:\n\n      "+_chalk2.default.cyan("$ now alias ls")+"\n\n  "+_chalk2.default.gray("‚Äì")+" Adds a new alias to "+_chalk2.default.underline("my-api.now.sh")+":\n\n      "+_chalk2.default.cyan("$ now alias set "+_chalk2.default.underline("api-ownv3nc9f8.now.sh")+" "+_chalk2.default.underline("my-api.now.sh"))+"\n\n      The "+_chalk2.default.dim("`.now.sh`")+" suffix can be ommited:\n\n      "+_chalk2.default.cyan("$ now alias set api-ownv3nc9f8 my-api")+"\n\n      The deployment id can be used as the source:\n\n      "+_chalk2.default.cyan("$ now alias set deploymentId my-alias")+"\n\n      Custom domains work as alias targets:\n\n      "+_chalk2.default.cyan("$ now alias set "+_chalk2.default.underline("api-ownv3nc9f8.now.sh")+" "+_chalk2.default.underline("my-api.com"))+"\n\n      "+_chalk2.default.dim("‚Äì")+" The subcommand "+_chalk2.default.dim("`set`")+" is the default and can be skipped.\n      "+_chalk2.default.dim("‚Äì")+" "+_chalk2.default.dim("`http(s)://`")+" in the URLs is unneeded / ignored.\n\n  "+_chalk2.default.gray("‚Äì")+" Removing an alias:\n\n      "+_chalk2.default.cyan("$ now alias rm aliasId")+"\n\n      To get the list of alias ids, use "+_chalk2.default.dim("`now alias ls`")+".\n\n  "+_chalk2.default.dim("Alias:")+" ln\n")},debug=argv.debug,apiUrl=argv.url||"https://api.zeit.co",exit=function(e){setTimeout(function(){return process.exit(e||0)},100)};if(argv.help||!subcommand)help(),exit(0);else{var config=cfg.read();_promise2.default.resolve(config.token||(0,_login2.default)(apiUrl)).then(function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,run(r);case 3:e.next=9;break;case 5:e.prev=5,e.t0=e.catch(0),e.t0.userError?(0,_error.error)(e.t0.message):(0,_error.error)("Unknown error: "+e.t0.stack),exit(1);case 9:case"end":return e.stop()}},e,void 0,[[0,5]])}));return function(r){return e.apply(this,arguments)}}()).catch(function(e){(0,_error.error)("Authentication error ‚Äì "+e.message),exit(1)})}